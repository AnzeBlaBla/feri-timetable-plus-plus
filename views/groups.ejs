<%- include("partials/header") %>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Select Your Course Groups</h1>
                <a href="/" class="btn btn-outline-secondary">‚Üê Back to URL Input</a>
            </div>
            
            <div class="alert alert-info mb-4">
                <strong>Filter ID:</strong> <%= filterId %>
                <br>
                <small>Select all the groups you're part of for each course below.</small>
                <% if (typeof previouslySelectedGroups !== 'undefined' && Object.keys(previouslySelectedGroups).length > 0) { %>
                    <br>
                    <small class="text-success"><i class="bi bi-check-circle"></i> Your previously selected groups have been restored.</small>
                <% } %>
            </div>

            <form id="groupSelectionForm" method="POST" action="/groups/submit">
                <input type="hidden" name="filterId" value="<%= filterId %>">
                
                <% if (courses.length === 0) { %>
                    <div class="alert alert-warning">
                        <h5>No courses found</h5>
                        <p>No course groups were found for this filter ID. This could mean:</p>
                        <ul>
                            <li>The timetable is empty or not yet available</li>
                            <li>The filter ID might be invalid</li>
                            <li>There might be a temporary issue with the FERI system</li>
                        </ul>
                    </div>
                <% } else { %>
                    <% courses.forEach((course, index) => { %>
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-book"></i>
                                    <%= course %>
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    Available groups: <%= courseGroups[course].length %>
                                </p>
                                
                                <div class="row">
                                    <% courseGroups[course].sort().forEach((group, groupIndex) => { %>
                                        <div class="col-md-6 col-lg-4 mb-2">
                                            <div class="form-check">
                                                <input 
                                                    class="form-check-input" 
                                                    type="checkbox" 
                                                    name="selectedGroups[<%= course %>][]" 
                                                    value="<%= group %>" 
                                                    id="group_<%= index %>_<%= groupIndex %>"
                                                    <% if (typeof previouslySelectedGroups !== 'undefined' && previouslySelectedGroups[course] && previouslySelectedGroups[course].includes(group)) { %>checked<% } %>
                                                >
                                                <label class="form-check-label" for="group_<%= index %>_<%= groupIndex %>">
                                                    <%= group %>
                                                </label>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                                
                                <div class="mt-3">
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-outline-primary me-2"
                                        onclick="selectAllForCourse('<%= course %>', <%= index %>)"
                                    >
                                        Select All
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-outline-secondary"
                                        onclick="deselectAllForCourse('<%= course %>', <%= index %>)"
                                    >
                                        Deselect All
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            Confirm Group Selection
                        </button>
                    </div>
                <% } %>
            </form>


        </div>
    </div>
</div>

<script>
// Select/Deselect all groups for a specific course
function selectAllForCourse(course, courseIndex) {
    const checkboxes = document.querySelectorAll(`input[name="selectedGroups[${course}][]"]`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
}

function deselectAllForCourse(course, courseIndex) {
    const checkboxes = document.querySelectorAll(`input[name="selectedGroups[${course}][]"]`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

// Simple form validation
document.getElementById('groupSelectionForm').addEventListener('submit', function(e) {
    const form = this;
    const checkboxes = form.querySelectorAll('input[type="checkbox"]');
    const checkedBoxes = form.querySelectorAll('input[type="checkbox"]:checked');
    
    if (checkedBoxes.length === 0) {
        e.preventDefault();
        
        // Show error message
        const existingError = document.querySelector('.temp-error-alert');
        if (existingError) {
            existingError.remove();
        }
        
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-danger alert-dismissible temp-error-alert mt-3';
        errorAlert.innerHTML = `
            <strong>Error:</strong> Please select at least one group from any course.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        form.parentNode.insertBefore(errorAlert, form);
        errorAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorAlert.parentNode) {
                errorAlert.remove();
            }
        }, 5000);
        
        return false;
    }
    
    // Show loading state
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Processing...';
    submitButton.disabled = true;
});
</script>

<%- include("partials/footer") %>